<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Infrastructure - Terraform+Swarm+DO</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Infrastructure";
    var mkdocs_page_input_path = "infra.md";
    var mkdocs_page_url = "/infra/index.html";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../index.html" class="icon icon-home"> Terraform+Swarm+DO</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../index.html">Main</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../dev/index.html">Development</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../stag/index.html">Staging</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../prod/index.html">Production</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="index.html">Infrastructure</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#infrastucture-environment">Infrastucture environment</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#ssh-keys">SSH keys</a></li>
        
            <li><a class="toctree-l3" href="#cluster-deployment">Cluster deployment</a></li>
        
            <li><a class="toctree-l3" href="#adding-more-nodes">Adding more nodes</a></li>
        
            <li><a class="toctree-l3" href="#docker-container-deployment">Docker container deployment</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../docs/index.html">Documentation</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Terraform+Swarm+DO</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
    
      
    
    <li>Infrastructure</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="infrastucture-environment">Infrastucture environment</h1>
<p>It's a docker swarm based environment separated from Pitchup to host infrastructure tools.</p>
<p>Tools used:</p>
<ul>
<li>Terraform</li>
<li>AWS EC2</li>
<li>AWS VPC</li>
<li>Docker-compose</li>
</ul>
<h2 id="ssh-keys">SSH keys</h2>
<p>Copy ssh key:</p>
<pre><code class="bash">cp docker-infra/terraform/pitchup.pem ~/.ssh/pitchup.pem
chmod 600 ~/.ssh/pitchup.pem
</code></pre>

<p>Now you need to start using ssh-agent, be sure it's loaded and running. </p>
<p>Load ssh key to ssh-agent:</p>
<pre><code class="bash">ssh-add .ssh/do.pem
</code></pre>

<h2 id="cluster-deployment">Cluster deployment</h2>
<p>To deploy a cluster or any changes in it's setup - you need to install and run <a href="https://www.terraform.io">Terraform</a>.</p>
<pre><code>cd docker-infra/terraform
terraform apply
</code></pre>

<p>It's a good practise to run <code>terraform plan</code> before applying changes, to see what's will be changed in infrastructure.</p>
<p><strong>WARNING</strong>: Be VERY carefull using Terraform, if you remove something from script or resource will be changed too drastically, terraform might remove that resource and install new one, this can lead to data loss! Always use <code>terraform plan</code> before applying changes!</p>
<h2 id="adding-more-nodes">Adding more nodes</h2>
<p>In <code>variables.tf</code> file you can change these parameters to increase certain node count:</p>
<ul>
<li><code>cluster_manager_count</code></li>
<li><code>cluster_node_count</code></li>
<li><code>cluster_gocd_agent_count</code></li>
</ul>
<p>After that run <code>terraform plan</code> to preview what changes will be made, and then only then <code>terraform apply</code></p>
<h2 id="docker-container-deployment">Docker container deployment</h2>
<h3 id="local-docker-setup">Local docker setup</h3>
<pre><code class="bash">cp docker-infra/terraform/certs/ca.pem ~/.docker
cp docker-infra/terraform/certs/key.pem ~/.docker
cp docker-infra/terraform/certs/cert.pem ~/.docker
</code></pre>

<h3 id="docker-compose-usage">Docker-compose usage</h3>
<p>You need to specify which docker host you want to manage and authorize there to make changes:</p>
<pre><code class="bash">cd docker-infra/compose
export DOCKER_HOST=tcp://&lt;swarm_master_node_hostname_here&gt;:2376
docker --tls stack deploy --compose-file=compose.yml infra
</code></pre>

<p>To get master node ip address do this:</p>
<pre><code class="bash">cd docker-infra/terraform
terraform output
</code></pre>

<p>Or there's a Makefile <code>docker-infra/</code> directory:</p>
<p>Just do:</p>
<pre><code class="bash">make deploy
</code></pre>

<h3 id="force-update-image">Force update image</h3>
<p>You might need to set DOCKER_HOST for that node where image is stored</p>
<pre><code>docker --tls pull pitchup/gocd-server:latest
</code></pre>

<p>Force update service</p>
<pre><code>docker --tls service update --force --detach=false infra_gocd-server
</code></pre>

<h3 id="destroying-cluster">Destroying cluster</h3>
<p>This will destroy all resources that terraform creted on AWS:</p>
<pre><code class="bash">terraform destroy
</code></pre>

<p><strong>WARNING</strong>: You will never use that unless setting up new cluster for testing.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../docs/index.html" class="btn btn-neutral float-right" title="Documentation">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../prod/index.html" class="btn btn-neutral" title="Production"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../prod/index.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../docs/index.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
